function BufferLoader(e,t,n){this.context=e,this.urlList=t,this.onload=n,this.bufferList=new Array,this.loadCount=0}function nextNote(){var e=60/tempo;nextNoteTime+=.25*e,current16thNote++,16==current16thNote&&(current16thNote=0)}function playSound(e,t,n){var o=context.createBufferSource();o.buffer=e,"kick"===n?(gainNode.kick=context.createGain(),o.connect(gainNode.kick),gainNode.kick.connect(context.destination),gainNode.kick.gain.value=interactions.kickVolume):"highhum"===n?(gainNode.highhum=context.createGain(),o.connect(gainNode.highhum),gainNode.highhum.connect(context.destination),gainNode.highhum.gain.value=interactions.highhumVolume):o.connect(context.destination),o.start(t)}function scheduleNote(e,t){notesInQueue.push({note:e,time:t});var n=0;e%16===0&&queueActive(),e%4===0?runKick():e%2===0&&runSnare()}function queueActive(){playSound(stems[1],0,"hum"),playAway&&(playSound(stems[0],0,"kick"),playSound(stems[2],0,"highhum"))}function runKick(){kick_elements.toggleClass("kick")}function runSnare(){snare_elements.toggleClass("snare")}function scheduler(){for(;nextNoteTime<context.currentTime+scheduleAheadTime;)scheduleNote(current16thNote,nextNoteTime),nextNote();timerID=window.setTimeout(scheduler,lookahead)}function play(){return isPlaying=!isPlaying,isPlaying?(current16thNote=0,nextNoteTime=context.currentTime,scheduler(),"stop"):(window.clearTimeout(timerID),"play")}function init(){var e=document.createElement("div");window.context=window.context||window.webkitcontext,context=new AudioContext,bufferLoader=new BufferLoader(context,["moth_stems/drums_excited.mp3","moth_stems/hum_base.mp3","moth_stems/hum_high.mp3"],finishedLoading),bufferLoader.load()}function finishedLoading(e){stems=e,play()}var context=null,isPlaying=!1,startTime,current16thNote,tempo=58.81,lookahead=25,scheduleAheadTime=.1,nextNoteTime=0,noteResolution=2,noteLength=.1,timerID=0,canvas,canvasContext,last16thNoteDrawn=-1,notesInQueue=[],playAway=!1,kick_elements=null,snare_elements=null,bufferLoader,stems,gainNode={kick:null,highhum:null},interactions={kickVolume:1,highhumVolume:1};window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}(),BufferLoader.prototype.loadBuffer=function(e,t){var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="arraybuffer";var o=this;n.onload=function(){o.context.decodeAudioData(n.response,function(n){return n?(o.bufferList[t]=n,void(++o.loadCount==o.urlList.length&&o.onload(o.bufferList))):void alert("error decoding file data: "+e)},function(e){console.error("decodeAudioData error",e)})},n.onerror=function(){alert("BufferLoader: XHR error")},n.send()},BufferLoader.prototype.load=function(){for(var e=0;e<this.urlList.length;++e)this.loadBuffer(this.urlList[e],e)},window.addEventListener("load",init),$(document).ready(function(){kick_elements=$("[data-kick]"),snare_elements=$("[data-snare]"),$("html").mousemove(function(e){playAway&&(null!==gainNode.kick&&(kickVolume=e.pageY/1e3,gainNode.kick.gain.value=kickVolume,interactions.kickVolume=kickVolume),null!==gainNode.highhum&&(highhumVolume=e.pageX/1e3,gainNode.highhum.gain.value=highhumVolume,interactions.highhumVolume=highhumVolume))}),$("body").hammer().on("doubletap",function(){window.playAway=!window.playAway})});